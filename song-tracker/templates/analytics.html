{% extends "base.html" %}
{% block title %}Analytics â€” Song Tracker{% endblock %}

{% block nav_extra %}
<a href="/splits" class="nav-link">Splits</a>
<a href="/imports" class="nav-link">Imports</a>
<a href="/analytics" class="nav-link active">Analytics</a>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Analytics &amp; Reference</h1>
    <div class="subtitle">Territory rates, distributor fees, PRO rates, and catalog health</div>
</div>

<!-- Catalog Health -->
<div class="stats-row">
    <div class="stat-card">
        <div class="label">Total Songs</div>
        <div class="value accent">{{ songs_total }}</div>
    </div>
    <div class="stat-card">
        <div class="label">With Splits Assigned</div>
        <div class="value green">{{ songs_with_splits }}</div>
    </div>
    <div class="stat-card">
        <div class="label">Missing Splits</div>
        <div class="value" style="color: var(--yellow);">{{ songs_total - songs_with_splits }}</div>
    </div>
    <div class="stat-card">
        <div class="label">Catalog Value</div>
        <div class="value green">${{ "%.2f"|format(grand_total) }}</div>
    </div>
</div>

<!-- Artist breakdown chart -->
<div class="grid-2">
    <div class="card">
        <div class="card-header">Songs by Artist</div>
        <div class="card-body">
            <div class="chart-container">
                <canvas id="artistPieChart"></canvas>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">Catalog Health</div>
        <div class="card-body">
            <div class="chart-container">
                <canvas id="healthChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Territory Multipliers -->
<div class="card">
    <div class="card-header">Territory Rate Multipliers</div>
    <div class="card-body">
        <p style="color: var(--text-dim); font-size: 14px; margin-bottom: 16px;">
            Per-stream rates are adjusted by territory. US = 1.0x (baseline).
        </p>
        <div class="chart-container" style="height: 350px;">
            <canvas id="territoryChart"></canvas>
        </div>
    </div>
</div>

<!-- Distributor Fees -->
<div class="grid-2">
    <div class="card">
        <div class="card-header">Distributor Fee Comparison</div>
        <div class="card-body" style="padding: 0;">
            <table>
                <thead>
                    <tr>
                        <th>Distributor</th>
                        <th>Model</th>
                        <th class="text-right">Annual Fee</th>
                        <th class="text-right">Rev Share</th>
                        <th>Net on $1,000</th>
                    </tr>
                </thead>
                <tbody>
                    {% for name, d in distributor_fees.items() %}
                    {% set net = 1000 - (1000 * d.rev_share) - (d.annual_fee if d.type == 'flat' else 0) %}
                    <tr>
                        <td style="font-weight: 600;">{{ name|title }}</td>
                        <td><span class="badge {% if d.type == 'flat' %}badge-green{% else %}badge-purple{% endif %}">{{ d.type }}</span></td>
                        <td class="text-right mono">${{ "%.2f"|format(d.annual_fee) }}</td>
                        <td class="text-right mono">{{ "%.0f"|format(d.rev_share * 100) }}%</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span class="mono" style="color: var(--green);">${{ "%.2f"|format(net) }}</span>
                                <div class="progress-bar" style="flex: 1;">
                                    <div class="fill fill-green" style="width: {{ (net / 1000 * 100)|int }}%"></div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- PRO Rates -->
    <div class="card">
        <div class="card-header">PRO Rate Breakdown</div>
        <div class="card-body" style="padding: 0;">
            <table>
                <thead>
                    <tr>
                        <th>PRO</th>
                        <th class="text-right">Writer Share</th>
                        <th class="text-right">Publisher Share</th>
                        <th class="text-right">Admin Fee</th>
                        <th>Net on $1,000</th>
                    </tr>
                </thead>
                <tbody>
                    {% for name, r in pro_rates.items() %}
                    {% set net = 1000 * (1 - r.admin_rate) %}
                    <tr>
                        <td style="font-weight: 600;">{{ name }}</td>
                        <td class="text-right mono">{{ "%.0f"|format(r.writer_share * 100) }}%</td>
                        <td class="text-right mono">{{ "%.0f"|format(r.publisher_share * 100) }}%</td>
                        <td class="text-right mono">{{ "%.1f"|format(r.admin_rate * 100) }}%</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span class="mono" style="color: var(--accent);">${{ "%.0f"|format(net) }}</span>
                                <div class="progress-bar" style="flex: 1;">
                                    <div class="fill fill-accent" style="width: {{ (net / 1000 * 100)|int }}%"></div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Artist pie chart
const artistData = {{ artist_songs|tojson }};
const artistNames = Object.keys(artistData);
const artistCounts = artistNames.map(a => artistData[a].length);
const colors = ['#58a6ff', '#3fb950', '#bc8cff', '#f0883e', '#f778ba', '#d29922', '#f85149'];

new Chart(document.getElementById('artistPieChart'), {
    type: 'doughnut',
    data: {
        labels: artistNames,
        datasets: [{
            data: artistCounts,
            backgroundColor: colors.slice(0, artistNames.length),
            borderColor: '#161b22',
            borderWidth: 2,
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { position: 'right', labels: { color: '#e6edf3', font: { size: 13 } } }
        }
    }
});

// Health chart
new Chart(document.getElementById('healthChart'), {
    type: 'doughnut',
    data: {
        labels: ['Splits Assigned', 'Missing Splits'],
        datasets: [{
            data: [{{ songs_with_splits }}, {{ songs_total - songs_with_splits }}],
            backgroundColor: ['#3fb950', '#30363d'],
            borderColor: '#161b22',
            borderWidth: 2,
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { position: 'right', labels: { color: '#e6edf3', font: { size: 13 } } }
        }
    }
});

// Territory chart
const territories = {{ territory_multipliers|tojson }};
const sorted = Object.entries(territories).sort((a, b) => b[1] - a[1]);
const tLabels = sorted.map(t => t[0]);
const tValues = sorted.map(t => t[1] * 100);
const tColors = tValues.map(v => v >= 75 ? '#3fb950' : v >= 25 ? '#d29922' : '#f85149');

new Chart(document.getElementById('territoryChart'), {
    type: 'bar',
    data: {
        labels: tLabels,
        datasets: [{
            label: 'Rate Multiplier (%)',
            data: tValues,
            backgroundColor: tColors,
            borderRadius: 3,
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        indexAxis: 'y',
        scales: {
            x: {
                ticks: { color: '#8b949e', callback: v => v + '%' },
                grid: { color: '#30363d' },
                max: 105,
            },
            y: {
                ticks: { color: '#e6edf3', font: { size: 11 } },
                grid: { display: false },
            }
        },
        plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: ctx => ctx.parsed.x.toFixed(0) + '% of US rate' } }
        }
    }
});
</script>
{% endblock %}
